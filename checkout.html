<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Checkout | Artisans Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">

    <style>
        .checkout-wrapper {
            display: flex;
            gap: 30px;
            padding: 40px;
            background: lightcyan;
        }

        .checkout-box {
            background: white;
            padding: 25px;
            border-radius: 10px;
            flex: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
        }

        .order-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background: #f5f5f5;
        }

        .place-btn {
            background: #179fc5;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <h1>Artisans Art Store</h1>
        <p><small>Handmade & Eco-Friendly Products</small></p>
    </header>

    <div class="checkout-wrapper">

        <div class="checkout-box">
            <h3>Delivery Details</h3>

            <input id="name" placeholder="Full Name">
            <input id="phone" placeholder="Mobile Number" maxlength="10"
                oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <input id="email" placeholder="Email">

            <textarea id="address" placeholder="House No, Street, Area"></textarea>

            <input id="city" placeholder="City" oninput="calculateDelivery()">
            <input id="state" placeholder="State">
            <input id="pincode" placeholder="Pincode">

            <h3>Payment Method</h3>
            <label><input type="radio" name="pay" value="COD" checked onclick="togglePay()"> Cash on
                Delivery</label><br>
            <label><input type="radio" name="pay" value="UPI" onclick="togglePay()"> UPI</label><br>
            <label><input type="radio" name="pay" value="Card" onclick="togglePay()"> Card</label>

            <input id="upi" class="hidden" placeholder="Enter UPI ID">
            <div id="cardBox" class="hidden">
                <input placeholder="Card Number">
                <input placeholder="Expiry MM/YY">
                <input placeholder="CVV">
            </div>

            <button class="place-btn" onclick="placeOrder()">Place Order</button>
        </div>

        <div class="checkout-box">
            <h3>Order Summary</h3>
            <div id="items"></div>
            <p>Subtotal: ₹<span id="subtotal">0</span></p>
            <p>Delivery: ₹<span id="delivery">0</span></p>
            <p><b>Total: ₹<span id="total">0</span></b></p>
        </div>

    </div>

    <script>
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        let subtotal = 0;
        let deliveryFee = 50;

        cart.forEach(i => {
            subtotal += i.price * i.qty;
            document.getElementById("items").innerHTML += `
    <div class="order-item">
      <img src="${i.image}">
      <div>${i.name}<br>${i.qty} × ₹${i.price}</div>
    </div>`;
        });
        document.getElementById("subtotal").innerText = subtotal;

        function calculateDelivery() {
            let city = document.getElementById("city").value.toLowerCase();
            deliveryFee = 50;
            if (city.includes("hyderabad")) deliveryFee = 30;
            if (city.includes("delhi")) deliveryFee = 60;
            if (city.includes("mumbai")) deliveryFee = 70;
            document.getElementById("delivery").innerText = deliveryFee;
            document.getElementById("total").innerText = subtotal + deliveryFee;
        }

        function togglePay() {
            let p = document.querySelector("input[name='pay']:checked").value;
            upi.classList.add("hidden");
            cardBox.classList.add("hidden");
            if (p === "UPI") upi.classList.remove("hidden");
            if (p === "Card") cardBox.classList.remove("hidden");
        }

        function placeOrder() {
            if (phone.value.length !== 10) { alert("Invalid phone"); return; }

            let payment = document.querySelector("input[name='pay']:checked").value;
            if (payment === "UPI" && !upi.value.includes("@")) { alert("Invalid UPI"); return; }

            let userEmail = localStorage.getItem("loggedInUser");
            if (!userEmail) {
                alert("Please login first");
                window.location.href = "auth.html";
                return;
            }

            let order = {
                id: "ART" + " " + Math.floor(Math.random() * 1000000),
                name: name.value,
                phone: phone.value,
                address: address.value,
                city: city.value,
                payment: payment,
                items: cart,
                subtotal: subtotal,
                delivery: deliveryFee,
                total: subtotal + deliveryFee,
                date: new Date().toISOString(),
                status: "Order Placed"
            };

            localStorage.setItem("loggedInUser", userEmail);

            let ordersByUser = JSON.parse(localStorage.getItem("ordersByUser")) || {};
            let userOrders = ordersByUser[userEmail] || [];

            userOrders.push(order);
            ordersByUser[userEmail] = userOrders;

            localStorage.setItem("ordersByUser", JSON.stringify(ordersByUser));
            localStorage.setItem("activeOrderId", order.id);

            localStorage.removeItem("cart");

            window.location.href = "thankyou.html";
        }

        // INITIAL CALCULATION
        //calculateDelivery();
        // CART COUNT UPDATE
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const count = cart.reduce((s, i) => s + i.qty, 0);
            const el = document.getElementById("cartCount");
            if (el) el.innerText = count;
        }
        updateCartCount();

    </script>


</body>

</html>